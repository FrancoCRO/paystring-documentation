(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{100:function(e,t,r){"use strict";r.d(t,"a",(function(){return u})),r.d(t,"b",(function(){return d}));var a=r(0),n=r.n(a);function i(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function s(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,a)}return r}function o(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?s(Object(r),!0).forEach((function(t){i(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):s(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function c(e,t){if(null==e)return{};var r,a,n=function(e,t){if(null==e)return{};var r,a,n={},i=Object.keys(e);for(a=0;a<i.length;a++)r=i[a],t.indexOf(r)>=0||(n[r]=e[r]);return n}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)r=i[a],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(n[r]=e[r])}return n}var l=n.a.createContext({}),p=function(e){var t=n.a.useContext(l),r=t;return e&&(r="function"==typeof e?e(t):o(o({},t),e)),r},u=function(e){var t=p(e.components);return n.a.createElement(l.Provider,{value:t},e.children)},b={inlineCode:"code",wrapper:function(e){var t=e.children;return n.a.createElement(n.a.Fragment,{},t)}},m=n.a.forwardRef((function(e,t){var r=e.components,a=e.mdxType,i=e.originalType,s=e.parentName,l=c(e,["components","mdxType","originalType","parentName"]),u=p(r),m=a,d=u["".concat(s,".").concat(m)]||u[m]||b[m]||i;return r?n.a.createElement(d,o(o({ref:t},l),{},{components:r})):n.a.createElement(d,o({ref:t},l))}));function d(e,t){var r=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=r.length,s=new Array(i);s[0]=m;var o={};for(var c in t)hasOwnProperty.call(t,c)&&(o[c]=t[c]);o.originalType=e,o.mdxType="string"==typeof e?e:a,s[1]=o;for(var l=2;l<i;l++)s[l]=r[l];return n.a.createElement.apply(null,s)}return n.a.createElement.apply(null,r)}m.displayName="MDXCreateElement"},65:function(e,t,r){"use strict";r.r(t),r.d(t,"frontMatter",(function(){return s})),r.d(t,"metadata",(function(){return o})),r.d(t,"rightToc",(function(){return c})),r.d(t,"default",(function(){return p}));var a=r(2),n=r(7),i=(r(0),r(100)),s={id:"metrics",title:"Metrics",sidebar_label:"Metrics"},o={unversionedId:"metrics",id:"metrics",isDocsHomePage:!1,title:"Metrics",description:"The reference implementation of PayString server automatically collects metrics using Prometheus. By default, metrics are pushed to the RippleX Prometheus pushgateway. This document describes how you can explicitly configure the PayString server to push to RippleX, or how to collect and analyze these metrics using your own metrics server.",source:"@site/docs/metrics.md",permalink:"/payid-documentation/review-apps/loisrp-test-run/fc54b5/metrics",editUrl:"https://github.com/paystring/paystring-documentation/tree/master/docs/metrics.md",sidebar_label:"Metrics",sidebar:"docs",previous:{title:"Integrate Existing User Databases",permalink:"/payid-documentation/review-apps/loisrp-test-run/fc54b5/integrate-paystring-users"},next:{title:"Deployment Options",permalink:"/payid-documentation/review-apps/loisrp-test-run/fc54b5/intro-deploy"}},c=[{value:"Reporting metrics to RippleX",id:"reporting-metrics-to-ripplex",children:[]},{value:"Available metrics",id:"available-metrics",children:[]},{value:"Import metrics from the PayString server to Prometheus",id:"import-metrics-from-the-paystring-server-to-prometheus",children:[{value:"How to pull metrics to Prometheus",id:"how-to-pull-metrics-to-prometheus",children:[]},{value:"How to push metrics from the PayString server to Prometheus",id:"how-to-push-metrics-from-the-paystring-server-to-prometheus",children:[]}]},{value:"Visualize metrics with Prometheus and Grafana",id:"visualize-metrics-with-prometheus-and-grafana",children:[]},{value:"Deploy a PayString server with Docker, and pull PayString metrics into Prometheus",id:"deploy-a-paystring-server-with-docker-and-pull-paystring-metrics-into-prometheus",children:[{value:"Prerequisites",id:"prerequisites",children:[]},{value:"Build a Docker container for setting up a PayString server",id:"build-a-docker-container-for-setting-up-a-paystring-server",children:[]},{value:"Create Docker network for PayString",id:"create-docker-network-for-paystring",children:[]},{value:"Start a Postgres Database",id:"start-a-postgres-database",children:[]},{value:"Start and test the PayString server",id:"start-and-test-the-paystring-server",children:[]},{value:"Start Prometheus",id:"start-prometheus",children:[]}]}],l={rightToc:c};function p(e){var t=e.components,r=Object(n.a)(e,["components"]);return Object(i.b)("wrapper",Object(a.a)({},l,r,{components:t,mdxType:"MDXLayout"}),Object(i.b)("p",null,"The reference implementation of PayString server automatically collects metrics using Prometheus. By default, metrics are pushed to the RippleX Prometheus pushgateway. This document describes how you can explicitly configure the PayString server to push to RippleX, or how to collect and analyze these metrics using your own metrics server."),Object(i.b)("h2",{id:"reporting-metrics-to-ripplex"},"Reporting metrics to RippleX"),Object(i.b)("p",null,"RippleX runs a metrics collection server for general use by anyone running a PayString server. Sharing your metrics with RippleX allows the PayString community to aggregate and monitor PayString adoption and growth metrics in one place."),Object(i.b)("p",null,"Metrics are reported to RippleX by default but you can push metrics to your own Prometheus pushgateway. Here's how to configure your PayString server to do that:"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-sh"}),"# RippleX's Prometheus pushgateway\nPUSH_GATEWAY_URL=https://push00.mon.payid.tech\n")),Object(i.b)("p",null,"To opt out of pushing metrics entirely, set the following environment variable on your server:"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-sh"}),"PUSH_PAYID_METRICS=false\n")),Object(i.b)("h2",{id:"available-metrics"},"Available metrics"),Object(i.b)("p",null,"The PayString server captures the following metrics."),Object(i.b)("table",null,Object(i.b)("thead",{parentName:"table"},Object(i.b)("tr",{parentName:"thead"},Object(i.b)("th",Object(a.a)({parentName:"tr"},{align:null}),"Metric"),Object(i.b)("th",Object(a.a)({parentName:"tr"},{align:null}),"Description"))),Object(i.b)("tbody",{parentName:"table"},Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(i.b)("inlineCode",{parentName:"td"},"payid_count")),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"The number of PayString address mappings in the system. This is calculated periodically by querying the PayString database and published as metrics periodically (every 60 seconds by default). In Prometheus terms, this metric is a gauge.")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(i.b)("inlineCode",{parentName:"td"},"payid_count.paymentNetwork")),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"The payment network for the PayString address mapping. (XRPL, BTC, ETH, ACH, ...)")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(i.b)("inlineCode",{parentName:"td"},"payid_count.environment")),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"The payment network\u2019s environment for the PayString address mapping (MAINNET, TESTNET, RINKEBY, ...)")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(i.b)("inlineCode",{parentName:"td"},"payid_lookup_request")),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"The number of PayString lookup requests. This metric is updated every time a PayString server is hit with a HTTP request to look up an address or addresses for a PayString.")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(i.b)("inlineCode",{parentName:"td"},"payid_lookup_request.paymentNetwork")),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"The payment network for the PayString address mapping. (XRPL, BTC, ETH, ACH, ...)")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(i.b)("inlineCode",{parentName:"td"},"payid_lookup_request.environment")),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"The payment network\u2019s environment for the PayString address mapping (MAINNET, TESTNET, RINKEBY, ...)")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(i.b)("inlineCode",{parentName:"td"},"payid_lookup_request.result")),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"The result of the lookup. Possible values include: ",Object(i.b)("ul",null,Object(i.b)("li",null,Object(i.b)("inlineCode",{parentName:"td"},"found")," - An address was found for the PayString lookup."),Object(i.b)("li",null,Object(i.b)("inlineCode",{parentName:"td"},"not_found")," - An address was not found for the PayString lookup (HTTP status code 404)"),Object(i.b)("li",null,Object(i.b)("inlineCode",{parentName:"td"},"error")," - There was an error in the PayString lookup request. For example, if the client provided an Accept request header that was invalid or missing.")))))),Object(i.b)("p",null,"You can use this data to generate real-time charts. For example, this chart shows how many PayString address mappings exist in the system over time:\n",Object(i.b)("img",Object(a.a)({parentName:"p"},{src:"/img/docs/paystring_address_count.png",alt:"PayString address mappings in system over time"}))),Object(i.b)("p",null,"This chart shows the rate per minute of PayString lookup requests:\n",Object(i.b)("img",Object(a.a)({parentName:"p"},{src:"/img/docs/paystring_lookups.png",alt:"PayString lookups per minute"}))),Object(i.b)("h2",{id:"import-metrics-from-the-paystring-server-to-prometheus"},"Import metrics from the PayString server to Prometheus"),Object(i.b)("p",null,"You can use a push or pull method to obtain metrics from Prometheus."),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Tip:")," Note that both push and pull methods can be used together simultaneously. For example, to pull metrics into an internal Prometheus server and push metrics to a third-party Prometheus server like RippleX."),Object(i.b)("h3",{id:"how-to-pull-metrics-to-prometheus"},"How to pull metrics to Prometheus"),Object(i.b)("p",null,"Prometheus pulls metrics by scraping a known endpoint for metrics data. The PayString server exposes metrics in Prometheus format on the admin port (default ",Object(i.b)("inlineCode",{parentName:"p"},"8081"),"). For simplicity, you can configure Prometheus to scrape metrics directly from the PayString server. Prometheus must be running inside the same network as PayString server because Prometheus needs access to the admin port. If multiple instances of the PayString server are being run behind a load balancer, then Prometheus must pull metrics directly from each instance, not through the load balancer. This direct method is recommended for collecting metrics using your own Prometheus server."),Object(i.b)("p",null,"Here is a sample ",Object(i.b)("inlineCode",{parentName:"p"},"prometheus.yml")," configuration file set up to pull metrics from a PayString server running locally."),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-yml"}),"# my global config\nglobal:\n  scrape_interval: 15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.\n  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.\n  # scrape_timeout is set to the global default (10s).\n\n# A scrape configuration containing exactly one endpoint to scrape:\n# Here it's Prometheus itself.\nscrape_configs:\n  # The job name is added as a label `job=<job_name>` to any timeseries scraped from this config.\n  - job_name: 'prometheus'\n    honor_labels: true\n    # metrics_path defaults to '/metrics'\n    # scheme defaults to 'http'.\n\n    static_configs:\n      - targets: ['localhost:8081']\n")),Object(i.b)("h3",{id:"how-to-push-metrics-from-the-paystring-server-to-prometheus"},"How to push metrics from the PayString server to Prometheus"),Object(i.b)("p",null,"Alternatively, you can push metrics from the PayString server to Prometheus using a ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://github.com/prometheus/pushgateway"}),"pushgateway"),". This setup requires running a pushgateway in addition to a Prometheus server, and configuring the PayString server to push metrics to the pushgateway. Prometheus then pulls metrics from the pushgateway. In this setup, Prometheus and pushgateway do not need to run inside the same network as the PayString server(s), but the PayString server must be able to reach the pushgateway over http. This is the recommended method for pushing metrics to a third party such as RippleX."),Object(i.b)("p",null,"By default, the reference PayString server pushes metrics to the RippleX pushgateway. To push metrics to your own pushgateway, follow these steps:"),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},"Set the environment variables ",Object(i.b)("inlineCode",{parentName:"li"},"PUSH_GATEWAY_URL")," with the url to your pushgateway."),Object(i.b)("li",{parentName:"ol"},"Restart your PayString server.")),Object(i.b)("p",null,"For example, if the fictitious company Vandelay Industries wants to push metrics to a pushgateway running at ",Object(i.b)("inlineCode",{parentName:"p"},"https://some-pushgateway.com"),", then set these environment variables: ",Object(i.b)("inlineCode",{parentName:"p"},"PUSH_GATEWAY_URL= https://some-pushgateway.com"),"."),Object(i.b)("p",null,"By default, a PayString server will push metrics every 15 seconds to the configured pushgateway. To change this frequency, set the ",Object(i.b)("inlineCode",{parentName:"p"},"PUSH_METRICS_INTERVAL")," value. For example, to push every 5 minutes (300 seconds), set ",Object(i.b)("inlineCode",{parentName:"p"},"PUSH_METRICS_INTERVAL=300"),". This value must be a positive number."),Object(i.b)("p",null,"As mentioned above, you can also explicitly set ",Object(i.b)("inlineCode",{parentName:"p"},"PUSH_GATEWAY_URL=https://push00.mon.payid.tech")," to push the metrics from your PayString server to RippleX."),Object(i.b)("h2",{id:"visualize-metrics-with-prometheus-and-grafana"},"Visualize metrics with Prometheus and Grafana"),Object(i.b)("p",null,"Prometheus has an admin web console with limited visualization capabilities on port 9090 (default), as shown in this example."),Object(i.b)("p",null,Object(i.b)("img",Object(a.a)({parentName:"p"},{src:"/img/docs/prometheus-metrics.png",alt:"PayString metrics on Prometheus"}))),Object(i.b)("p",null,"To build dashboards with multiple charts, you can ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://prometheus.io/docs/visualization/grafana/"}),"use Grafana and configure Prometheus as a datasource"),"."),Object(i.b)("h2",{id:"deploy-a-paystring-server-with-docker-and-pull-paystring-metrics-into-prometheus"},"Deploy a PayString server with Docker, and pull PayString metrics into Prometheus"),Object(i.b)("p",null,"In this tutorial, you will deploy a PayString server and run Prometheus locally using Docker, and you will create a configuration file for the PayString server so that PayString metrics are pulled into Prometheus."),Object(i.b)("h3",{id:"prerequisites"},"Prerequisites"),Object(i.b)("p",null,"Install the following software on your machine, if not already present."),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",Object(a.a)({parentName:"li"},{href:"https://www.npmjs.com/get-npm"}),"npm")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",Object(a.a)({parentName:"li"},{href:"https://docs.docker.com/get-docker/"}),"docker")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",Object(a.a)({parentName:"li"},{href:"https://git-scm.com/book/en/v2/Getting-Started-Installing-Git"}),"git"))),Object(i.b)("h3",{id:"build-a-docker-container-for-setting-up-a-paystring-server"},"Build a Docker container for setting up a PayString server"),Object(i.b)("p",null,"Run these commands to build a Docker container for a PayString server."),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash"}),"git clone https://github.com/paystring/paystring.git\ncd paystring\ndocker build -t paystring-server .\n")),Object(i.b)("h3",{id:"create-docker-network-for-paystring"},"Create Docker network for PayString"),Object(i.b)("p",null,"You will run several containers in Docker that must talk to each other. To set up these containers, create a docker network called ",Object(i.b)("inlineCode",{parentName:"p"},"paystring-network"),"."),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash"}),"docker network create paystring-network\n")),Object(i.b)("h3",{id:"start-a-postgres-database"},"Start a Postgres Database"),Object(i.b)("p",null,"To have a PayString server, you require a Postgres database to store PayString accounts and address mappings. To do this, run the postgres database in docker with a default password of ",Object(i.b)("inlineCode",{parentName:"p"},"password"),", and tell the database to use the ",Object(i.b)("inlineCode",{parentName:"p"},"paystring-network")," that you previously created. Name this docker container ",Object(i.b)("inlineCode",{parentName:"p"},"paystring-postgres"),", so that you can reference the container by name when you connect your PayString server. Note that both the default database and the user are named ",Object(i.b)("inlineCode",{parentName:"p"},"postgres"),", as described at ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://hub.docker.com/_/postgres"}),"Postgres Docker Official Images"),"."),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash"}),"docker run -d --rm --name paystring-postgres --network paystring-network -e POSTGRES_PASSWORD=password postgres\n")),Object(i.b)("h3",{id:"start-and-test-the-paystring-server"},"Start and test the PayString server"),Object(i.b)("p",null,"To start the PayString server, run the PayString server in docker using the image you created. You must also use the docker network ",Object(i.b)("inlineCode",{parentName:"p"},"paystring-network")," so that it can connect to the ",Object(i.b)("inlineCode",{parentName:"p"},"paystring-postgres")," container."),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash"}),"docker run -it -p 8080:8080 -p 8081:8081 --name paystring-server --network paystring-network -e DB_PASSWORD=password -e\n    DB_NAME=postgres -e DB_HOSTNAME=paystring-postgres paystring-server\n")),Object(i.b)("p",null,"Test whether the PayString server is running by creating a PayString with this cURL command."),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash"}),' curl --location --request POST \'http://127.0.0.1:8081/users\' --header \'PayID-API-Version: 2020-06-16\' --header \'Content-Type: application/json\' --data-raw \'{\n     "payId": "charlie$127.0.0.1",\n     "addresses": [\n         {\n             "paymentNetwork": "XRPL",\n             "environment": "TESTNET",\n             "details": {\n                 "address": "rDk7FQvkQxQQNGTtfM2Fr66s7Nm3k87vdS"\n             }\n         }\n     ]\n }\'\n')),Object(i.b)("p",null,"You should get a ",Object(i.b)("inlineCode",{parentName:"p"},"Created")," response."),Object(i.b)("p",null,"Query the PayString server to make sure it resolves, using this cURL command."),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash"}),'curl http://127.0.0.1:8080/charlie -H "PayID-Version: 1.0" -H "Accept: application/xrpl-testnet+json"`\n')),Object(i.b)("h3",{id:"start-prometheus"},"Start Prometheus"),Object(i.b)("p",null,"In this step, you will run prometheus in docker and configure it to scrape the PayString server\u2019s metrics. To do this, you need to create a ",Object(i.b)("inlineCode",{parentName:"p"},"prometheus.yml")," file on the host machine and mount it in the docker container."),Object(i.b)("p",null,"Create a file named ",Object(i.b)("inlineCode",{parentName:"p"},"prometheus.yml")," with these contents."),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-yml"}),"global:\n  scrape_interval: 15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.\n  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.\n\nscrape_configs:\n  - job_name: 'paystring-metric'\n    honor_labels: true\n    static_configs:\n      - targets: ['paystring-server:8081']\n")),Object(i.b)("p",null,"Start the docker container:"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash"}),"docker run -d --network paystring-network -p 9090:9090 -v $PWD/prometheus.yml:/etc/prometheus/prometheus.yml prom/prometheus`\n")),Object(i.b)("p",null,"You can verify Prometheus is running by opening ",Object(i.b)("inlineCode",{parentName:"p"},"http://localhost:9090/graph")," in a browser."),Object(i.b)("p",null,"You can verify metrics collection metrics are being collected by entering the following expression into the form:"),Object(i.b)("p",null,Object(i.b)("inlineCode",{parentName:"p"},"sum(payid_count)")),Object(i.b)("p",null,"Click ",Object(i.b)("inlineCode",{parentName:"p"},"Execute"),". If successful, the results look like this:"),Object(i.b)("p",null,Object(i.b)("img",Object(a.a)({parentName:"p"},{src:"/img/docs/prometheus-sum.png",alt:"PayString Metrics setup and configuration"}))),Object(i.b)("p",null,"Click the ",Object(i.b)("strong",{parentName:"p"},"Graph")," tab to display the results in graph format."),Object(i.b)("p",null,"Here are some other example expressions:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"sum(payid_count) by (paymentNetwork)")," - Sum of ",Object(i.b)("inlineCode",{parentName:"li"},"PayString")," count by payment network, such as XRPL, BTC, and so forth."),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"sum(payid_lookup_request)")," - Total number of ",Object(i.b)("inlineCode",{parentName:"li"},"PayString")," lookup requests."),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"rate(payid_lookup_request[5m])")," - Rate of ",Object(i.b)("inlineCode",{parentName:"li"},"PayString")," lookup requests per second.")))}p.isMDXComponent=!0}}]);